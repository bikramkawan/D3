const newData = [
    {
        date: '01-Apr-07',
        category: 'ignored',
        percentage: 20,
        clicked: 3,
    },
    {
        date: '03-Apr-07',
        category: 'ignored',
        percentage: 30,
        clicked: 5,
    },
    {
        date: '04-Apr-07',
        category: 'ignored',
        percentage: 10,
        clicked: 7,
    },
    {
        date: '05-Apr-07',
        category: 'ignored',
        percentage: 50,
        clicked: 1,
    },
    {
        date: '06-Apr-07',
        category: 'ignored',
        percentage: 27,
        clicked: 3,
    },
    {
        date: '07-Apr-07',
        category: 'ignored',
        percentage: 6,
        clicked: 5,
    },
    {
        date: '08-Apr-07',
        category: 'ignored',
        percentage: 5,
        clicked: 4,
    },
    {
        date: '09-Apr-07',
        category: 'ignored',
        percentage: 2,
        clicked: 1,
    },
    {
        date: '10-Apr-07',
        category: 'ignored',
        percentage: 6,
        clicked: 2,
    },

    {
        date: '01-Apr-07',
        category: 'skimmed',
        percentage: 5,
        clicked: 3,
    },
    {
        date: '03-Apr-07',
        category: 'skimmed',
        percentage: 8,
        clicked: 3,
    },
    {
        date: '04-Apr-07',
        category: 'skimmed',
        percentage: 5,
        clicked: 5,
    },
    {
        date: '05-Apr-07',
        category: 'skimmed',
        percentage: 2,
        clicked: 7,
    },
    {
        date: '06-Apr-07',
        category: 'skimmed',
        percentage: 7,
        clicked: 4,
    },
    {
        date: '07-Apr-07',
        category: 'skimmed',
        percentage: 9,
        clicked: 2,
    },
    {
        date: '08-Apr-07',
        category: 'skimmed',
        percentage: 2,
        clicked: 6,
    },
    {
        date: '09-Apr-07',
        category: 'skimmed',
        percentage: 5,
        clicked: 2,
    },
    {
        date: '10-Apr-07',
        category: 'skimmed',
        percentage: 5,
        clicked: 5,
    },

    {
        date: '01-Apr-07',
        category: 'read',
        percentage: 5,
        clicked: 5,
    },
    {
        date: '03-Apr-07',
        category: 'read',
        percentage: 7,
        clicked: 15,
    },
    {
        date: '04-Apr-07',
        category: 'read',
        percentage: 5,
        clicked: 2,
    },
    {
        date: '05-Apr-07',
        category: 'read',
        percentage: 6,
        clicked: 5,
    },
    {
        date: '06-Apr-07',
        category: 'read',
        percentage: 5,
        clicked: 5,
    },
    {
        date: '07-Apr-07',
        category: 'read',
        percentage: 5,
        clicked: 5,
    },
    {
        date: '08-Apr-07',
        category: 'read',
        percentage: 5,
        clicked: 2,
    },
    {
        date: '09-Apr-07',
        category: 'read',
        percentage: 5,
        clicked: 4,
    },
    {
        date: '10-Apr-07',
        category: 'read',
        percentage: 7,
        clicked: 3,
    },

    {
        date: '01-Apr-07',
        category: 'undeliverable',
        percentage: 8,
        clicked: 1,
    },
    {
        date: '03-Apr-07',
        category: 'undeliverable',
        percentage: 7,
        clicked: 5,
    },
    {
        date: '04-Apr-07',
        category: 'undeliverable',
        percentage: 8,
        clicked: 5,
    },
    {
        date: '05-Apr-07',
        category: 'undeliverable',
        percentage: 6,
        clicked: 7,
    },
    {
        date: '06-Apr-07',
        category: 'undeliverable',
        percentage: 5,
        clicked: 5,
    },
    {
        date: '07-Apr-07',
        category: 'undeliverable',
        percentage: 5,
        clicked: 3,
    },
    {
        date: '08-Apr-07',
        category: 'undeliverable',
        percentage: 6,
        clicked: 5,
    },
    {
        date: '09-Apr-07',
        category: 'undeliverable',
        percentage: 5,
        clicked: 7,
    },
    {
        date: '10-Apr-07',
        category: 'undeliverable',
        percentage: 5,
        clicked: 3,
    },

    {
        date: '01-Apr-07',
        category: 'out of office',
        percentage: 8,
        clicked: 5,
    },
    {
        date: '03-Apr-07',
        category: 'out of office',
        percentage: 5,
        clicked: 5,
    },
    {
        date: '04-Apr-07',
        category: 'out of office',
        percentage: 7,
        clicked: 5,
    },
    {
        date: '05-Apr-07',
        category: 'out of office',
        percentage: 7,
        clicked: 5,
    },
    {
        date: '06-Apr-07',
        category: 'out of office',
        percentage: 5,
        clicked: 3,
    },
    {
        date: '07-Apr-07',
        category: 'out of office',
        percentage: 8,
        clicked: 3,
    },
    {
        date: '08-Apr-07',
        category: 'out of office',
        percentage: 2,
        clicked: 7,
    },
    {
        date: '09-Apr-07',
        category: 'out of office',
        percentage: 5,
        clicked: 7,
    },
    {
        date: '10-Apr-07',
        category: 'out of office',
        percentage: 7,
        clicked: 8,
    },

    {
        date: '01-Apr-07',
        category: 'unsubscribed',
        percentage: 2,
        clicked: 1,
    },
    {
        date: '03-Apr-07',
        category: 'unsubscribed',
        percentage: 5,
        clicked: 3,
    },
    {
        date: '04-Apr-07',
        category: 'unsubscribed',
        percentage: 4,
        clicked: 7,
    },
    {
        date: '05-Apr-07',
        category: 'unsubscribed',
        percentage: 4,
        clicked: 2,
    },
    {
        date: '06-Apr-07',
        category: 'unsubscribed',
        percentage: 7,
        clicked: 4,
    },
    {
        date: '07-Apr-07',
        category: 'unsubscribed',
        percentage: 3,
        clicked: 1,
    },
    {
        date: '08-Apr-07',
        category: 'unsubscribed',
        percentage: 1,
        clicked: 0,
    },
    {
        date: '09-Apr-07',
        category: 'unsubscribed',
        percentage: 2,
        clicked: 1,
    },
    {
        date: '10-Apr-07',
        category: 'unsubscribed',
        percentage: 7,
        clicked: 5,
    },
];

const stackedData = [
    {
        date: '01-Apr-07',
        category: 'ignored',
        amount: 10,
    },
    {
        date: '03-Apr-07',
        category: 'ignored',
        amount: 20,
    },
    {
        date: '04-Apr-07',
        category: 'ignored',
        amount: 25,
    },
    {
        date: '05-Apr-07',
        category: 'ignored',
        amount: 5,
    },
    {
        date: '06-Apr-07',
        category: 'ignored',
        amount: 7,
    },
    {
        date: '07-Apr-07',
        category: 'ignored',
        amount: 10,
    },
    {
        date: '08-Apr-07',
        category: 'ignored',
        amount: 32,
    },
    {
        date: '09-Apr-07',
        category: 'ignored',
        amount: 2,
    },
    {
        date: '10-Apr-07',
        category: 'ignored',
        amount: 6,
    },

    {
        date: '01-Apr-07',
        category: 'skimmed',
        amount: 5,
    },
    {
        date: '03-Apr-07',
        category: 'skimmed',
        amount: 8,
    },
    {
        date: '04-Apr-07',
        category: 'skimmed',
        amount: 15,
    },
    {
        date: '05-Apr-07',
        category: 'skimmed',
        amount: 10,
    },
    {
        date: '06-Apr-07',
        category: 'skimmed',
        amount: 17,
    },
    {
        date: '07-Apr-07',
        category: 'skimmed',
        amount: 9,
    },
    {
        date: '08-Apr-07',
        category: 'skimmed',
        amount: 21,
    },
    {
        date: '09-Apr-07',
        category: 'skimmed',
        amount: 5,
    },
    {
        date: '10-Apr-07',
        category: 'skimmed',
        amount: 10,
    },

    {
        date: '01-Apr-07',
        category: 'read',
        amount: 15,
    },
    {
        date: '03-Apr-07',
        category: 'read',
        amount: 20,
    },
    {
        date: '04-Apr-07',
        category: 'read',
        amount: 5,
    },
    {
        date: '05-Apr-07',
        category: 'read',
        amount: 12,
    },
    {
        date: '06-Apr-07',
        category: 'read',
        amount: 20,
    },
    {
        date: '07-Apr-07',
        category: 'read',
        amount: 15,
    },
    {
        date: '08-Apr-07',
        category: 'read',
        amount: 5,
    },
    {
        date: '09-Apr-07',
        category: 'read',
        amount: 10,
    },
    {
        date: '10-Apr-07',
        category: 'read',
        amount: 7,
    },

    {
        date: '01-Apr-07',
        category: 'other1',
        amount: 8,
    },
    {
        date: '03-Apr-07',
        category: 'other1',
        amount: 15,
    },
    {
        date: '04-Apr-07',
        category: 'other1',
        amount: 20,
    },
    {
        date: '05-Apr-07',
        category: 'other1',
        amount: 30,
    },
    {
        date: '06-Apr-07',
        category: 'other1',
        amount: 10,
    },
    {
        date: '07-Apr-07',
        category: 'other1',
        amount: 5,
    },
    {
        date: '08-Apr-07',
        category: 'other1',
        amount: 15,
    },
    {
        date: '09-Apr-07',
        category: 'other1',
        amount: 10,
    },
    {
        date: '10-Apr-07',
        category: 'other1',
        amount: 5,
    },

    {
        date: '01-Apr-07',
        category: 'other2',
        amount: 18,
    },
    {
        date: '03-Apr-07',
        category: 'other2',
        amount: 10,
    },
    {
        date: '04-Apr-07',
        category: 'other2',
        amount: 15,
    },
    {
        date: '05-Apr-07',
        category: 'other2',
        amount: 10,
    },
    {
        date: '06-Apr-07',
        category: 'other2',
        amount: 5,
    },
    {
        date: '07-Apr-07',
        category: 'other2',
        amount: 10,
    },
    {
        date: '08-Apr-07',
        category: 'other2',
        amount: 10,
    },
    {
        date: '09-Apr-07',
        category: 'other2',
        amount: 20,
    },
    {
        date: '10-Apr-07',
        category: 'other2',
        amount: 15,
    },
];

const color = {
    ignored: '#B4C3CA',
    skimmed: '#76E49C',
    read: '#3ED772',
    other1: '#2CC7B4',
    other2: '#2CC7B4',
    undeliverable: '#2CC7B4',
    'out of office': '#2CC7B4',
    unsubscribed: '#1489c7',
};

const taskPiData = [
    {
        date: '01-Apr-07',
        category: 'ignored',
        amount: 10,
        previous: 3,
    },
    {
        date: '03-Apr-07',
        category: 'ignored',
        amount: 20,
        previous: 5,
    },
    {
        date: '04-Apr-07',
        category: 'ignored',
        amount: 25,
        previous: 7,
    },
    {
        date: '05-Apr-07',
        category: 'ignored',
        amount: 5,
        previous: 1,
    },
    {
        date: '06-Apr-07',
        category: 'ignored',
        amount: 7,
        previous: 3,
    },
    {
        date: '07-Apr-07',
        category: 'ignored',
        amount: 10,
        previous: 5,
    },
    {
        date: '08-Apr-07',
        category: 'ignored',
        amount: 32,
        previous: 10,
    },
    {
        date: '09-Apr-07',
        category: 'ignored',
        amount: 2,
        previous: 1,
    },
    {
        date: '10-Apr-07',
        category: 'ignored',
        amount: 6,
        previous: 2,
    },

    {
        date: '01-Apr-07',
        category: 'skimmed',
        amount: 5,
        previous: 3,
    },
    {
        date: '03-Apr-07',
        category: 'skimmed',
        amount: 8,
        previous: 3,
    },
    {
        date: '04-Apr-07',
        category: 'skimmed',
        amount: 15,
        previous: 5,
    },
    {
        date: '05-Apr-07',
        category: 'skimmed',
        amount: 10,
        previous: 7,
    },
    {
        date: '06-Apr-07',
        category: 'skimmed',
        amount: 17,
        previous: 10,
    },
    {
        date: '07-Apr-07',
        category: 'skimmed',
        amount: 9,
        previous: 2,
    },
    {
        date: '08-Apr-07',
        category: 'skimmed',
        amount: 21,
        previous: 12,
    },
    {
        date: '09-Apr-07',
        category: 'skimmed',
        amount: 5,
        previous: 2,
    },
    {
        date: '10-Apr-07',
        category: 'skimmed',
        amount: 10,
        previous: 5,
    },

    {
        date: '01-Apr-07',
        category: 'read',
        amount: 15,
        previous: 10,
    },
    {
        date: '03-Apr-07',
        category: 'read',
        amount: 20,
        previous: 15,
    },
    {
        date: '04-Apr-07',
        category: 'read',
        amount: 5,
        previous: 2,
    },
    {
        date: '05-Apr-07',
        category: 'read',
        amount: 12,
        previous: 10,
    },
    {
        date: '06-Apr-07',
        category: 'read',
        amount: 20,
        previous: 10,
    },
    {
        date: '07-Apr-07',
        category: 'read',
        amount: 15,
        previous: 10,
    },
    {
        date: '08-Apr-07',
        category: 'read',
        amount: 5,
        previous: 2,
    },
    {
        date: '09-Apr-07',
        category: 'read',
        amount: 10,
        previous: 4,
    },
    {
        date: '10-Apr-07',
        category: 'read',
        amount: 7,
        previous: 3,
    },

    {
        date: '01-Apr-07',
        category: 'undeliverable',
        amount: 8,
        previous: 1,
    },
    {
        date: '03-Apr-07',
        category: 'undeliverable',
        amount: 15,
        previous: 10,
    },
    {
        date: '04-Apr-07',
        category: 'undeliverable',
        amount: 20,
        previous: 5,
    },
    {
        date: '05-Apr-07',
        category: 'undeliverable',
        amount: 30,
        previous: 7,
    },
    {
        date: '06-Apr-07',
        category: 'undeliverable',
        amount: 10,
        previous: 5,
    },
    {
        date: '07-Apr-07',
        category: 'undeliverable',
        amount: 5,
        previous: 3,
    },
    {
        date: '08-Apr-07',
        category: 'undeliverable',
        amount: 15,
        previous: 5,
    },
    {
        date: '09-Apr-07',
        category: 'undeliverable',
        amount: 10,
        previous: 7,
    },
    {
        date: '10-Apr-07',
        category: 'undeliverable',
        amount: 5,
        previous: 3,
    },

    {
        date: '01-Apr-07',
        category: 'out of office',
        amount: 18,
        previous: 10,
    },
    {
        date: '03-Apr-07',
        category: 'out of office',
        amount: 10,
        previous: 5,
    },
    {
        date: '04-Apr-07',
        category: 'out of office',
        amount: 15,
        previous: 10,
    },
    {
        date: '05-Apr-07',
        category: 'out of office',
        amount: 10,
        previous: 5,
    },
    {
        date: '06-Apr-07',
        category: 'out of office',
        amount: 5,
        previous: 3,
    },
    {
        date: '07-Apr-07',
        category: 'out of office',
        amount: 10,
        previous: 3,
    },
    {
        date: '08-Apr-07',
        category: 'out of office',
        amount: 10,
        previous: 7,
    },
    {
        date: '09-Apr-07',
        category: 'out of office',
        amount: 20,
        previous: 7,
    },
    {
        date: '10-Apr-07',
        category: 'out of office',
        amount: 15,
        previous: 8,
    },

    {
        date: '01-Apr-07',
        category: 'unsubscribed',
        amount: 2,
        previous: 1,
    },
    {
        date: '03-Apr-07',
        category: 'unsubscribed',
        amount: 5,
        previous: 3,
    },
    {
        date: '04-Apr-07',
        category: 'unsubscribed',
        amount: 10,
        previous: 7,
    },
    {
        date: '05-Apr-07',
        category: 'unsubscribed',
        amount: 4,
        previous: 2,
    },
    {
        date: '06-Apr-07',
        category: 'unsubscribed',
        amount: 7,
        previous: 4,
    },
    {
        date: '07-Apr-07',
        category: 'unsubscribed',
        amount: 3,
        previous: 1,
    },
    {
        date: '08-Apr-07',
        category: 'unsubscribed',
        amount: 1,
        previous: 0,
    },
    {
        date: '09-Apr-07',
        category: 'unsubscribed',
        amount: 2,
        previous: 1,
    },
    {
        date: '10-Apr-07',
        category: 'unsubscribed',
        amount: 7,
        previous: 5,
    },
];

const width = 900;
const height = 300;

const excludeCategoryName = ['ID', 'SentDate', 'ClickCount', 'report_type_id'];

const getColor = () => {
    return (
        '#' +
        '0123456789abcdef'
            .split('')
            .map(function(v, i, a) {
                return i > 5 ? null : a[Math.floor(Math.random() * 16)];
            })
            .join('')
    );
};
const colorbrewer = [
    '#f7fcfd',
    '#e5f5f9',
    '#ccece6',
    '#99d8c9',
    '#66c2a4',
    '#41ae76',
    '#238b45',
    '#006d2c',
    '#00441b',
];

const categoriesToRender = [
    {
        category: 'EngagedReadRate',
        color: '#e5f5f9',
        percentage: 'PercentRead',
        clickCount: 'EngagedRead_clickRate',
    },
    {
        category: 'IgnoredRate',
        color: '#ccece6',
        percentage: 'PercentRead',
        clickCount: 'ignored_clickRate',
    },
    {
        category: 'LeftOpenRate',
        color: '#99d8c9',
        percentage: 'PercentRead',
        clickCount: 'LeftOpen_clickrate',
    },
    {
        category: 'ReadRate',
        color: '#66c2a4',
        percentage: 'PercentRead',
        clickCount: 'Read_clickRate',
        hasPercentageLine: true,
    },
    {
        category: 'SkimmedRate',
        color: '#41ae76',
        percentage: 'PercentRead',
        clickCount: 'skimmed_clickRate',
    },
    // {
    //     category: 'Skimmed',
    //     color: '#2CC7B4',
    //     percentage: 'SkimmedRate',
    //     clickCount: 'ClickCount',
    // },
    // {
    //     category: 'UndeliverableCount',
    //     color: '#238b45',
    //     percentage: 'UndeliverableRate',
    //     clickCount: 'ClickCount',
    // },
    // {
    //     category: 'ReplyCount',
    //     color: '#006d2c',
    //     percentage: 'ReplyRate',
    //     clickCount: 'ClickCount',
    // },
    // {
    //     category: 'EngagedReads',
    //     color: '#00441b',
    //     percentage: 'EngagedReadRate',
    //     clickCount: 'ClickCount',
    // },
];

const trimString = (string, stringWidth, width) => {
    if (stringWidth > width) {
        return 'a';
    }
};
const strictIsoParse = d3.time.format('%Y-%m-%d %H:%M:%S');
const strictIsoDate = d3.time.format('%Y-%m-%d');
const requiredFormat = d3.time.format('%d-%b-%y');
const getDay = d3.time.format('%d');
const dateString = '2018-04-23T15:25:52';

queue()
    .defer(d3.csv, 'data/heatdata.csv')
    .defer(d3.csv, 'data/scoredata.csv')
    .awaitAll(ready);

function ready(err, results) {
    console.error(results);
    const csvdata = results[0];
    const scoreData = results[1];
    // console.error(
    //     Date.parse(dateString),
    //     'dateobj',
    //     strictIsoParse.parse(dateString),
    //     requiredFormat(strictIsoParse.parse(dateString)),
    // );

    const singleHeatData = createHeatMapData([csvdata[0]]);
    const multipleHeatmap = createHeatMapData(csvdata);

    console.error(multipleHeatmap, 'flat', singleHeatData);

    const scoreDataCorrectDate = scoreData
        .map(s => {
            const formatDate = strictIsoDate.parse(s.SentDate.split('T')[0]);
            return {
                ...s,
                date: formatDate ? requiredFormat(formatDate) : null,
                days: formatDate ? getDay(formatDate) : null,
            };
        })
        .filter(f => f.date);

    const keys = Object.keys(scoreDataCorrectDate[0])
        .filter(f => f)
        .filter(e => e !== 'days' && e !== 'date');
    const parseScored = scoreDataCorrectDate
        .map(s => {
            const obj = {};

            keys.forEach(k => (obj[k] = Math.abs(parseFloat(s[k]))));

            return { ...s, ...obj };
        })
        .slice()
        .sort((a, b) => parseFloat(a.days) - parseFloat(b.days));

    console.error(scoreDataCorrectDate, 'scored', parseScored);
    const singleHeatMap = new SingleHeatMap({
        data: singleHeatData,
        width,
        height,
    });
    singleHeatMap.draw();
    const arrayHeatMap = new MultipleHeatmap({
        data: multipleHeatmap,
        width,
        height,
    });
    arrayHeatMap.draw();

    // const stackedChart = new StackedChart({
    //     stackedData,
    //     color,
    //     width,
    //     height,
    // });
    // stackedChart.draw();
    // //
    const stackedScore = new ScoresInStacked({
        data: parseScored,
        width,
        height,
        topLine: {
            name: 'OpenRate',
            color: 'green',
        },
        bottomLine: {
            name: 'IgnoredRate',
            color: 'grey',
        },
        horLine: {
            name: 'OpenRate',
            color: 'orange',
        },
        yDomain: [0, 1],
        sent: {
            name: 'Sent',
        },
        reach: {
            name: 'OpenRate',
        },
        uopen: {
            name: 'OpenCount',
        },
        triangle: {
            top: 'OpenRate',
            bottom: 'PreviousAttentionRate',
        },
        gauge: {
            outer: 'AttentionRate',
            inner: 'PreviousAttentionRate',
        },
        gaugeNumbers: {
            number1: 'AttentionRate',
            number2: 'PreviousAttentionRate',
            percNumber: 'AttentionRate',
        },
        bottomItems :'OpenRate'
    });

    stackedScore.draw();
    // const stackedScore = new ScoresInStacked({
    //     data: taskPiData,
    //     width,
    //     height,
    // });
}

function createHeatMapData(csvdata) {
    const validDateOnlyData = csvdata
        .map(item => {
            const formatDate = strictIsoParse.parse(
                item.sentdate.split('.')[0],
            );

            return {
                ...item,
                date: formatDate ? requiredFormat(formatDate) : null,
            };
        })
        .filter(d => d.date);

    const filteredData = validDateOnlyData.map(item => {
        const id = uid();
        return categoriesToRender.map(cat => {
            return {
                ...cat,
                date: item.date,
                category: cat.category,
                percentage: Math.min(
                    Math.abs(parseFloat(item[cat.percentage])),
                    1,
                ),
                clicked: Math.min(
                    Math.abs(parseFloat(item[cat.clickCount])),
                    1,
                ),
                color: cat.color,
                value: Math.min(Math.abs(parseFloat(item[cat.category])), 1),
                hasPercentageLine: (cat && cat.hasPercentageLine) || false,
                id,
            };
        });
    });

    return filteredData.reduce((acc, val) => acc.concat(val), []);
}

function uid() {
    return (
        '_' +
        Math.random()
            .toString(36)
            .substr(2, 9)
    );
}
